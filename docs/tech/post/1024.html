<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="keywords" content="vite 打包说明 ">
    <meta name="description" content="vite 打包说明 的前言 ">

    <link rel="short icon" href="../../assets/logo@x1.png" type="image/x-icon">
    <link rel="stylesheet" href="../../assets/common.css">
    <link rel="stylesheet" href="../../assets/iconfont.css">
    <link rel="stylesheet" href="../../assets/an-old-hope.min.css">
    <title>vite 打包说明 -Wheat October</title>
</head>
<body>
    <div class="_main">
        <header class="_header">
    <span class="_logo"> <a title="Back Home" href="/"></a> </span>
    <span class="_nav"><a href="/think/"> Think </a><a href="/tech/"> Tech </a><a href="/about/"> About </a> <a href="/rss.html"><i  class="iconfont icon-dingyue"></i> Rss</a></span>
</header>
        
        <main class="_content _arc">
            <h1>vite 打包说明 </h1>
            <p class="_info"> <span> <i class="iconfont icon-riqi"></i> 2023-05-08 </span> <span class="type"> <a href='/tech'>Tech </a> </span></p>
            <div class="_markdown">
                <!-- 1683514198710 -->
<!-- vite 打包说明 -->
<!-- vite 打包说明 的前言 -->
<!--  -->
<!-- Tech -->

<p>最近因为招到一个帮手，所以把一直落下的组件整理工作重拾起来，这次准备整理出来一套完全符合公司业务的功能套件，包含以下几个：</p>
<ul>
<li>前后端统一的（根据数据库字段实例模型字典生成）快速实现增删改查的组件，设计 Form 和 Table</li>
<li>符合时序数据库的自定义统计的前后端统一组件（用代码配置实现 BI，后端实现计算和聚合，没有用到 Grphql）</li>
<li>3D 库，对已经迭代过两次的基于 Threejs 封装的 3D 数字孪生场景开发库进行重构</li>
<li>算子与任务模块，实现与上述的自定义统计组件一体的算子定义（可以配合 Python，自定义统计可以根据数据内容得出相关的微分方程或者预测曲线公式），关联、任务调度设置功能</li>
<li>WebRTC 本地视频解码组件优化，这个组件实现了 web 界面的低延时 RTSP 流播放</li>
</ul>
<p>目标现在明确了，需要用 vite 进行组件打包甚至上传到 npm 包管理平台的需求，经过仔细阅读 vite 文档，把相关方法记录在此。</p>
<h3 id="配置-vite">配置 Vite</h3>
<p>根据需求得知我需要配置集中打包模式：App（文档），增删改查组件、3D 库、BI 组件、算子与任务模块、WebRTC 模块。可以这样做，再 <code>package.json</code> 如此配置：</p>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    ...
    &quot;build:lib&quot;: &quot;set BUILD_MODE=lib&amp;&amp; vite build&quot;,
  },
}
</code></pre>
<blockquote>
<p>这里要注意一下，<code>BUILD_MODE=lib&amp;&amp; vite build</code> 不要图好看写成 <code>BUILD_MODE=lib &amp;&amp; vite build</code> 把 lib 和 &amp;&amp; 空格开，这样就会导致 <code>process.env.BUILD_MODE === &#39;lib &#39;</code></p>
</blockquote>
<p>然后再 <code>vite.config.js</code> 里面做判断，对不同的打包要求进行不同的配置，大概如下所示：</p>
<pre><code class="language-js"><span class="hljs-keyword">if</span>( process.<span class="hljs-property">env</span>.<span class="hljs-property">BUILD_MODE</span> === <span class="hljs-string">&#x27;lib&#x27;</span> ){
    config.<span class="hljs-property">build</span> = {
      <span class="hljs-comment">// 这个库打包输出的目录，可以和其他的区分开</span>
      <span class="hljs-attr">outDir</span>: <span class="hljs-string">&quot;lib_name&quot;</span>, 
      <span class="hljs-attr">lib</span>: {
        <span class="hljs-comment">//指定组件编译入口文件</span>
        <span class="hljs-attr">entry</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;./src/package/index.js&quot;</span>),
        <span class="hljs-comment">// 打包后生成的全局变量名称 </span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;lib_name&quot;</span>,   
        <span class="hljs-comment">// 打包的 js 文件名</span>
        <span class="hljs-attr">fileName</span>: <span class="hljs-string">&quot;lib_name&quot;</span>,  
      },
      <span class="hljs-attr">rollupOptions</span>: {
        <span class="hljs-comment">// 确保外部化处理那些你不想打包进库的依赖</span>
        <span class="hljs-attr">external</span>: [<span class="hljs-string">&quot;vue&quot;</span>],
        <span class="hljs-attr">output</span>: {
          <span class="hljs-comment">// 在 UMD 构建模式下为这些外部化的依赖提供一个全局变量</span>
          <span class="hljs-attr">globals</span>: {
            <span class="hljs-attr">vue</span>: <span class="hljs-string">&quot;Vue&quot;</span>,
          }
        },
      }
    }
  }
</code></pre>
<p>如果还需要 publish 到 npm 平台，就需要配置一下两个地方：<code>package.json</code> 里面根下配置 </p>
<pre><code class="language-js">{
...
<span class="hljs-comment">// 指定你在 import &#x27;lib_name&#x27; 索引的文件</span>
<span class="hljs-string">&quot;main&quot;</span>: <span class="hljs-string">&quot;lib_name/lib_name.js&quot;</span>,
}
</code></pre>
<p>因为只有一个配置，所以如果要推动到 npm 只能是一个库一个 main 说明，如果你想全部都推上去，用一个 main 可以把其他的库都挂在 <code>./src/package/index.js</code> 里面输出，具体这样写：</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Table</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./table.vue&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Form</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./form.vue&quot;</span>;

<span class="hljs-keyword">import</span> lib2 <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./lib2.js&quot;</span>;
<span class="hljs-keyword">import</span> lib3 <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./lib3.js&quot;</span>;

<span class="hljs-keyword">const</span> component = [<span class="hljs-title class_">Table</span>,  <span class="hljs-title class_">Form</span> ];

<span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = <span class="hljs-title class_">App</span> =&gt; {
    component.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-title class_">App</span>.<span class="hljs-title function_">component</span>(item.<span class="hljs-property">name</span>, item);
    });
}

<span class="hljs-comment">// 判断是否是直接引入文件</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">Vue</span>) {
    <span class="hljs-title function_">install</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">Vue</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    install,
    <span class="hljs-title class_">Table</span>,
    <span class="hljs-title class_">Form</span>,
  lib2,
  lib3
};
</code></pre>
<p>另外还需要配置一下 <code>.npmignore</code>文件，避免把不需要的代码提交上去，里面的内容可以这么写：</p>
<pre><code class="language-bash">src/
dist/
public/
vite.config.js
README.md
</code></pre>
<p>好了，至此一个 vite 打包的较为详细的步骤就完成了，可以开心的写代码啦~~~</p>

            </div>
            <p class="_page"><span><a class="_next_arc" href="/tech/post/1025.html"> Pre </a></span><span></span> </p>
        </main>
        <footer class="_footer">
    <span class="__left">POWER BY <a href="/about">EASYBLOG</a></span>
    <span class="__right">
        <span class="___nav"><a href="/think/"> Think </a><a href="/tech/"> Tech </a><a href="/about/"> About </a></span>
        <a class="iconfont icon-tuite1" target="_blank" href="https://twitter.com/full_designer_"></a>
        <a class="iconfont icon-weixin" href=""></a>
    </span>
</footer>
    </div>
</body>
</html>